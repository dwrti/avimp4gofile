name: Video Converter & Gofile Uploader

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‡Ù†Ø§'
        required: true

jobs:
  convert_and_upload:
    runs-on: ubuntu-latest
    timeout-minutes: 60 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y ffmpeg jq curl

      - name: Download Video
        run: |
          curl -L --http1.1 --retry 10 --retry-max-time 1200 \
          "${{ github.event.inputs.video_url }}" \
          -o input_video_raw

      - name: Convert to Safari MP4
        run: |
          ffmpeg -i input_video_raw -c:v libx264 -profile:v main -level:v 4.0 \
          -pix_fmt yuv420p -c:a aac -b:a 128k -movflags +faststart output_video.mp4

      - name: Upload to Gofile
        id: upload
        run: |
          echo "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹..."
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¹ ÙØ­Øµ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
          SERVER_DATA=$(curl -s https://api.gofile.io/getServer)
          SERVER=$(echo $SERVER_DATA | jq -r '.data.server // "store1"')
          
          # Ø§Ù„Ø±ÙØ¹ Ù…Ø¹ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„ÙØ­Øµ Ù„Ùˆ Ù‚Ø¯Ø± Ø§Ù„Ù„Ù‡ ØµØ§Ø± Ø®Ø·Ø£
          RESPONSE=$(curl -F "file=@output_video.mp4" "https://${SERVER}.gofile.io/uploadFile")
          echo "Debug Response: $RESPONSE"
          
          DOWNLOAD_PAGE=$(echo $RESPONSE | jq -r '.data.downloadPage')
          
          if [ "$DOWNLOAD_PAGE" == "null" ]; then
            echo "ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ØŒ Ù†Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ø¨Ø³ÙŠØ±ÙØ± Ø§Ø­ØªÙŠØ§Ø·ÙŠ..."
            RESPONSE=$(curl -F "file=@output_video.mp4" "https://store1.gofile.io/uploadFile")
            DOWNLOAD_PAGE=$(echo $RESPONSE | jq -r '.data.downloadPage')
          fi

          echo "FINAL_URL=$DOWNLOAD_PAGE" >> $GITHUB_ENV

      - name: Final Summary
        run: |
          echo "### ðŸš€ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.FINAL_URL }}" != "null" ]; then
            echo "- ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­: [Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„ØªØ­Ù…ÙŠÙ„](${{ env.FINAL_URL }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Ù„Ù„Ø£Ø³Ù ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù€ Gofile." >> $GITHUB_STEP_SUMMARY
          fi
